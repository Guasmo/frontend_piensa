<div class="outer-wrapper">
  <div class="panel-wrapper">
    <div *ngIf="isLoading" class="info-box">
      <h3>üîÑ Cargando...</h3>
      <p>Verificando estado del parlante...</p>
    </div>
    
    <div *ngIf="errorMessage" class="info-box" style="border-color: #dc3545; background: #f8d7da;">
      <h3 style="color: #721c24;">‚ùå Error</h3>
      <p style="color: #721c24;">{{ errorMessage }}</p>
    </div>

    <div *ngIf="!isLoading">
      <h2 class="title">Control Panel</h2>

      <!-- Informaci√≥n del Parlante -->
      <div class="info">
        <p>
          <strong>Nombre:</strong> 
          <span class="value">{{ speakerInfo.name }}</span>
        </p>
        <p>
          <strong>Posici√≥n:</strong> 
          <span class="value">{{ speakerInfo.position }}</span>
        </p>
        
        <!-- Estado de la Sesi√≥n -->
        <div class="toggle-container">
          <label class="switch">
            <input type="checkbox" [(ngModel)]="isConnected" (change)="toggleStatus()" />
            <span class="slider"></span>
          </label>
          <span class="status-label" [ngStyle]="{ color: isConnected ? '#28a745' : '#dc3545' }">
            {{ isConnected ? 'Sesi√≥n Activa' : 'Sesi√≥n Inactiva' }}
          </span>
        </div>

        <!-- Duraci√≥n de la Sesi√≥n y Contador de Mediciones -->
        <div *ngIf="isConnected" style="margin-top: 10px;">
          <p><strong>Duraci√≥n:</strong> <span class="value">{{ sessionDuration }}</span></p>
          <p><strong>Mediciones:</strong> <span class="value">{{ getMeasurementCount() }}</span></p>
        </div>

        <!-- Bot√≥n para mostrar/ocultar energ√≠a -->
        <button class="energy-button" (click)="toggleEnergy()">
          {{ showEnergy ? 'Ocultar Consumo de Energ√≠a ‚ñ≤'
                        : 'Mostrar Consumo de Energ√≠a ‚ñº' }}
        </button>
      </div>

      <!-- Secci√≥n de Energ√≠a -->
      <div id="energySection"
           class="metrics energy-content"
           [class.hidden]="!showEnergy">
        
        <ng-container *ngIf="latestMetrics; else noMetrics">
          <label>Voltaje Actual</label>
          <div class="metric-box">
            {{ formatNumber(latestMetrics.voltage_V, 2) }} V
            <small *ngIf="currentStats">(Promedio: {{ getRealtimeAverageVoltage() }} V)</small>
          </div>

          <label>Corriente Actual</label>
          <div class="metric-box">
            {{ formatNumber(latestMetrics.current_mA, 1) }} mA
            <small *ngIf="currentStats">(Promedio: {{ getRealtimeAverageCurrent() }} mA)</small>
          </div>

          <label>Potencia Actual</label>
          <div class="metric-box">
            {{ formatNumber(latestMetrics.power_mW, 1) }} mW
            <small *ngIf="currentStats">(Promedio: {{ getRealtimeAveragePower() }} mW)</small>
          </div>

          <label>Bater√≠a Restante</label>
          <div class="metric-box" [ngStyle]="{ 'background-color': getBatteryColor(), 'color': 'white' }">
            {{ formatNumber(latestMetrics.battery_remaining_percent, 1) }}% 
            ({{ getBatteryStatus() }})
          </div>

          <label>Consumo Total</label>
          <div class="metric-box">
            {{ formatNumber(latestMetrics.total_consumed_mAh, 1) }} mAh
            <small *ngIf="currentStats">(Calculado: {{ getTotalConsumed() }} mAh)</small>
          </div>

          <label>Muestra #</label>
          <div class="metric-box">
            {{ latestMetrics.sample_index }}
          </div>

          <!-- √öltima actualizaci√≥n -->
          <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
            <p>√öltima actualizaci√≥n: {{ latestMetrics.timestamp }}s desde el inicio</p>
            <p *ngIf="currentStats">Duraci√≥n total: {{ currentStats.durationSeconds }}s</p>
          </div>
        </ng-container>

        <ng-template #noMetrics>
          <div class="info-box" style="text-align: center;">
            {{ isConnected ? '‚è≥ Esperando primeros datos del ESP32...' : 'üîå Inicia una sesi√≥n para ver los datos.' }}
          </div>
        </ng-template>
      </div>

      <!-- Detalles de Energ√≠a Expandidos con Estad√≠sticas en Tiempo Real -->
      <div class="info-box" *ngIf="showEnergy && (latestMetrics || currentStats)">
        <h3>üìä Estad√≠sticas de la Sesi√≥n</h3>
        <ul>
          <li><strong>Estado de Bater√≠a:</strong> {{ getBatteryStatus() }}</li>
          <li *ngIf="currentStats"><strong>Potencia Promedio:</strong> {{ getRealtimeAveragePower() }} mW</li>
          <li *ngIf="peakPower > 0"><strong>Pico de Potencia:</strong> {{ formatNumber(peakPower, 1) }} mW</li>
          <li><strong>Duraci√≥n de Sesi√≥n:</strong> {{ sessionDuration }}</li>
          <li *ngIf="currentStats"><strong>Consumo Total Calculado:</strong> {{ getTotalConsumed() }} mAh</li>
          <li *ngIf="latestMetrics"><strong>Consumo Total ESP32:</strong> {{ formatNumber(latestMetrics.total_consumed_mAh, 1) }} mAh</li>
          <li *ngIf="currentStats"><strong>Corriente Promedio:</strong> {{ getRealtimeAverageCurrent() }} mA</li>
          <li *ngIf="currentStats"><strong>Voltaje Promedio:</strong> {{ getRealtimeAverageVoltage() }} V</li>
          <li><strong>Total de Mediciones:</strong> {{ getMeasurementCount() }}</li>
        </ul>
      </div>

      <!-- Informaci√≥n de Conectividad Mejorada -->
      <div class="info-box" *ngIf="isConnected" style="border-color: #28a745; background: #d4edda;">
        <h3 style="color: #155724;">‚úÖ ESP32 Conectado - Datos en Tiempo Real</h3>
        <p style="color: #155724;">
          Recibiendo datos cada 10 segundos desde memoria del servidor. 
          <strong>ID de Sesi√≥n:</strong> {{ activeSessionId }}
        </p>
        <p style="color: #155724; font-size: 12px;">
          Los datos se almacenan temporalmente y se guardar√°n al finalizar la sesi√≥n.
        </p>
      </div>

      <!-- ‚úÖ NUEVA: Informaci√≥n sobre el nuevo sistema -->
      <div class="info-box" *ngIf="!isConnected" style="border-color: #17a2b8; background: #d1ecf1;">
        <h3 style="color: #0c5460;">‚ÑπÔ∏è Sistema de Monitoreo en Tiempo Real</h3>
        <p style="color: #0c5460;">
          El sistema ahora procesa datos en tiempo real sin sobrecargar la base de datos. 
          Los datos se guardar√°n como resumen al finalizar la sesi√≥n.
        </p>
      </div>

      <!-- Botones de Acci√≥n -->
      <div class="button-group">
        <button class="back-button" routerLink="/dashboard/select-panel">Atr√°s</button>
        <button class="save-button" routerLink="/dashboard/select-panel">Guardar</button>
      </div>
    </div>
  </div>
</div>